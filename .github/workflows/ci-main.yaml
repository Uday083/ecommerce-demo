name: "Continuous Integration - Main/Release"

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**/README.md'
      - 'kustomize/**'
      - 'helm-chart/**'

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: ${{ secrets.GKE_CLUSTER_NAME }}    # e.g., online-boutique
  GKE_ZONE: ${{ secrets.GKE_ZONE }}               # e.g., us-central1-b
  DEPLOYMENT_NAME: online-boutique

jobs:
  build-and-deploy:
    name: Build and Deploy to GKE
    runs-on: ubuntu-latest

    steps:
    # 1. Checkout the repository code
    - name: Checkout Code
      uses: actions/checkout@v4

    # 2. Authenticate to Google Cloud
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_CREDENTIALS }}

    # 3. Set up Google Cloud SDK (gcloud)
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    # 4. Install gke-gcloud-auth-plugin (Required for GKE v1.26+)
    - name: Install GKE Auth Plugin
      run: |
        gcloud components install gke-gcloud-auth-plugin

    # 5. Get GKE Credentials to talk to the cluster
    - name: Get GKE Credentials
      uses: google-github-actions/get-gke-credentials@v2
      with:
        cluster_name: ${{ env.GKE_CLUSTER }}
        location: ${{ env.GKE_ZONE }}

    # 6. Install Skaffold (Tool used by this repo for building/deploying)
    - name: Setup Skaffold
      run: |
        curl -Lo skaffold https://storage.googleapis.com/skaffold/releases/latest/skaffold-linux-amd64 && \
        sudo install skaffold /usr/local/bin/

    # 7. Build and Deploy using Skaffold
    # --default-repo uses your Artifact Registry/Container Registry to store images
    - name: Skaffold Run
      run: |
        skaffold run --default-repo=gcr.io/${{ env.PROJECT_ID }}